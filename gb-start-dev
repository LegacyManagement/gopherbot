#!/bin/bash

# gb-start - convenience script for starting a Gopherbot dev container.

usage(){
	cat <<EOF

gb-start - Start a Gopherbot robot container for development.

Usage:
$ gb-start [-d] [-m] [-n] [-r] <robot>.env

Options:
-d : (dev) create a docker volume for /opt/gopherbot
-m : use the 'minimal' container (for use with remote code editors)
-n : don't pull containers
-r : start container as root user
-s : start a shell instead of gopherbot
<robot>.env : a developer profile generated by 'gb-dev-profile'
EOF
	exit 1
}

if [ ! -e "$HOME/.gitconfig" ]
then
	echo "Error: missing required $HOME/.gitconfig"
	usage
fi

PULL="always"
DEFAULT_CONTAINER="quay.io/lnxjedi/gopherbot-theia:latest"

while getopts ":dmnrs" OPT; do
    case $OPT in
	d )
		GOPHERBOT_VOLUME="-v gopherbot:/opt/gopherbot"
		;;
    m )
        DEFAULT_CONTAINER="quay.io/lnxjedi/gopherbot:latest"
        ;;
    n )
        PULL="never"
        ;;
	r )
		DOCKER_USER="-u root"
		;;
	s )
		ENTRYPOINT="--entrypoint /bin/bash"
		;;
    \? )
        echo "Invalid option: $OPTARG" >&2
		usage
        ;;
    esac
done
shift $((OPTIND -1))

if [ ! "$1" ]
then
	usage
fi

BOTENV="$1"
if [ ! -e "$BOTENV" ]
then
	if [ -e "$BOTENV.env" ]
	then
		BOTENV="$BOTENV.env"
	else
		usage
	fi
fi

BOTNAME=$(basename -s '.env' $BOTENV)

source $BOTENV
if [ ! "$GOPHER_DEV_PROFILE" ]
then
	echo "Error: '$BOTENV' doesn't appear to be a Gopherbot robot developer profile; see 'rc-dev-profile'"
	usage
fi

CONTAINER=${BOT_CONTAINER:-$DEFAULT_CONTAINER}

prep-container(){
	sleep 4
	while :
	do
		if docker exec $BOTNAME /bin/bash -c "pwd &>/dev/null" &>/dev/null
		then
			break
		fi
		sleep 1
	done
	docker cp $HOME/.gitconfig $BOTNAME:/var/lib/robot/.gitconfig
	docker exec -u root clu /bin/bash -c "chown robot:robot /var/lib/robot/.gitconfig"
	exit 0
}

prep-container &

docker run -it --rm -p=127.0.0.1:3000:3000 --pull=$PULL \
	--env-file $BOTENV --name $BOTNAME \
	-v $BOTNAME:/var/lib/robot \
	$GOPHERBOT_VOLUME $DOCKER_USER $ENTRYPOINT \
	$CONTAINER
