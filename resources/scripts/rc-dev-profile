#!/bin/bash

# rc-dev-profile - generate an environment file for robot development

usage(){
	cat <<EOF

rc-dev-profile - Generate an environment file for Gopherbot robot
development.

Usage:
$ rc-dev-profile [-e <email>] [-u <user>] [-s <path/to/private-key> ] <path/to/.env> (> myrobot.env)
EOF
	exit 1
}

GIT_USER=$(git config --get user.name)
GIT_EMAIL=$(git config --get user.email)
PRIVATE_KEY="$HOME/.ssh/id_rsa"
while getopts ":e:s:u:" OPT; do
    case $OPT in
	e )
		GIT_EMAIL="$OPTARG"
		;;
	u )
		GIT_USER="$OPTARG"
		;;
    s )
        PRIVATE_KEY="$OPTARG"
        ;;
    \? )
        echo "Invalid option: $OPTARG" >&2
		usage
        ;;
    esac
done
shift $((OPTIND -1))

if [ ! "$1" ]
then
	usage
fi

if [ ! -e "$PRIVATE_KEY" ]
then
	echo "Error: no '$PRIVATE_KEY' found, set with '-s' option."
	usage
fi

BOTENV="$1"
if [ ! -e "$BOTENV" ]
then
	if [ -e "$BOTENV.env" ]
	then
		BOTENV="$BOTENV.env"
	else
		usage
	fi
fi

source $BOTENV
for GVAR in GOPHER_ENCRYPTION_KEY GOPHER_CUSTOM_REPOSITORY GOPHER_DEPLOY_KEY
do
	if [ ! "${!GVAR}" ]
	then
		echo "Invalid environment file '$BOTENV', '$GVAR' not defined."
		usage
	fi
done

for GVAR in GIT_USER GIT_EMAIL
do
	if [ ! "${!GVAR}" ]
	then
		echo "Missin value for '$GVAR'; configure with 'git config ...' or pass the appropriate -u/-e option"
		usage
	fi
done

SSH_PRIVATE_KEY=$(cat $PRIVATE_KEY | tr ' \n' '_:')

cat <<EOF
# Generated by 'rc-dev-profile'
GOPHER_DEV_PROFILE=true
GOPHER_ENCRYPTION_KEY=$GOPHER_ENCRYPTION_KEY
GOPHER_CUSTOM_REPOSITORY=$GOPHER_CUSTOM_REPOSITORY
GOPHER_DEPLOY_KEY=$GOPHER_DEPLOY_KEY
# Defaulted by rc-dev-profile
GOPHER_PROTOCOL=terminal
GIT_AUTHOR_NAME="$GIT_USER"
GIT_AUTHOR_EMAIL="$GIT_EMAIL"
GIT_COMMITTER_NAME="$GIT_USER"
GIT_COMMITTER_EMAIL="$GIT_EMAIL"
DEV_PRIVATE_KEY=$SSH_PRIVATE_KEY
EOF
