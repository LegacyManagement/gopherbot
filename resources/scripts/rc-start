#!/bin/bash

# rc-start - convenience script for starting a Gopherbot dev container.

usage(){
	cat <<EOF

rc-start - Start a Gopherbot robot container for development.

Usage:
$ rc-start [-m] [-n] <robot>.env
Where:
-m : use the 'minimal' container (for use with remote code editors)
-n : don't pull containers
<robot>.env : a developer profile generated by 'rc-dev-profile'
EOF
	exit 1
}

PULL="always"
DEFAULT_CONTAINER="quay.io/lnxjedi/gopherbot-theia:latest"

while getopts ":mn" OPT; do
    case $OPT in
    m )
        DEFAULT_CONTAINER="quay.io/lnxjedi/gopherbot:latest"
        ;;
    n )
        PULL="never"
        ;;
    \? )
        echo "Invalid option: $OPTARG" >&2
		usage
        ;;
    esac
done
shift $((OPTIND -1))

if [ ! "$1" ]
then
	usage
fi

BOTENV="$1"
if [ ! -e "$BOTENV" ]
then
	if [ -e "$BOTENV.env" ]
	then
		BOTENV="$BOTENV.env"
	else
		usage
	fi
fi

BOTNAME=$(basename -s '.env' $BOTENV)

source $BOTENV
if [ ! "$GOPHER_DEV_PROFILE" ]
then
	echo "Error: '$BOTENV' doesn't appear to be a Gopherbot robot developer profile; see 'rc-dev-profile'"
	usage
fi

CONTAINER=${BOT_CONTAINER:-$DEFAULT_CONTAINER}

docker run -it --rm -p=127.0.0.1:3000:3000 --pull=$PULL \
	--env-file $BOTENV --name $BOTNAME \
	-v $BOTNAME:/var/lib/robot $CONTAINER
